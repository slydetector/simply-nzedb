#!/bin/bash
echo "Creating data directory..."
mkdir -p data

# Read in all custom settings as env vars
source etc/simply_nzedb.conf

cp etc/config.php.example data/config.php
sed -ri "s/changeme_nntp_username/${NNTP_USERNAME}/g" data/config.php
sed -ri "s/changeme_nntp_password/${NNTP_PASSWORD}/g" data/config.php
sed -ri "s/changeme_nntp_server/${NNTP_SERVER}/g" data/config.php
sed -ri "s/changeme_nntp_port/${NNTP_PORT}/g" data/config.php
sed -ri "s/changeme_nntp_sslenabled/${NNTP_SSLENABLED}/g" data/config.php

cp etc/nginx.conf.example data/nginx.conf
sed -ri "s/changeme_server_name/$(hostname)/g" data/nginx.conf

# Will end up mounted to /root/.mytop
cp etc/mytop data/mytop

mkdir -p data/covers/anime
mkdir -p data/covers/audio
mkdir -p data/covers/audiosample
mkdir -p data/covers/book
mkdir -p data/covers/console
mkdir -p data/covers/movies
mkdir -p data/covers/music
mkdir -p data/covers/preview
mkdir -p data/covers/sample
mkdir -p data/covers/tvshows
mkdir -p data/covers/video
mkdir -p data/nzb
mkdir -p data/tmp/unrar
mkdir -p data/etc_mysql_conf.d
mkdir -p data/var_lib_mysql
mkdir -p data/log
mkdir -p data/import/inbox

# Create as files otherwise docker will mount as directories 
touch data/log/nginx-access.log
touch data/log/nginx-error.log
touch data/log/php_errors.log
touch data/log/php-fpm.log

# File that lets mysql container know user id/gid on host
cat << EOF > data/mysql_user
PUID=$(id --user)
PGID=$(id --group)
EOF

# Save predb import progress across container start/stop.
# Written by predb_import_daily_batch.php
touch data/predb_progress.txt

# irc scraper 
cp etc/ircscraper_settings_example.php data/ircscraper_settings.php
sed -ri "s/changeme_irc_username/${IRC_USERNAME}/g" data/ircscraper_settings.php
sed -ri "s/changeme_irc_server/${IRC_SERVER}/g" data/ircscraper_settings.php
sed -ri "s/changeme_irc_port/${IRC_PORT}/g" data/ircscraper_settings.php
sed -ri "s/changeme_irc_tls/false/g" data/ircscraper_settings.php
sed -ri "s/changeme_irc_password/${IRC_PASSWORD}/g" data/ircscraper_settings.php

chmod -R 777 data
echo Done
